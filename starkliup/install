#!/bin/sh

set -e

# Fancy color setup:
#   https://unix.stackexchange.com/questions/9957/how-to-check-if-bash-can-print-colors
if test -t 1; then
    ncolors=$(tput colors)
    if test -n "$ncolors" && test $ncolors -ge 8; then
        bold="$(tput bold)"
        underline="$(tput smul)"
        standout="$(tput smso)"
        normal="$(tput sgr0)"
        black="$(tput setaf 0)"
        red="$(tput setaf 1)"
        green="$(tput setaf 2)"
        yellow="$(tput setaf 3)"
        blue="$(tput setaf 4)"
        magenta="$(tput setaf 5)"
        cyan="$(tput setaf 6)"
        white="$(tput setaf 7)"
    fi
fi

insert_env_line() {
    if [ -f "$1" ]; then
        if [ -z "$(cat "$1" | grep "${ENV_LINE}")" ]; then
            echo "${ENV_LINE}" >> "$1"
        fi
    fi
}

echo "Installing ${yellow}starkliup${normal}..."

BASE_DIR=${XDG_CONFIG_HOME:-$HOME}
STARKLI_DIR=${STARKLI_DIR-"$BASE_DIR/.starkli"}
STARKLI_BIN_DIR="$STARKLI_DIR/bin"
STARKLI_MAN_DIR="$STARKLI_DIR/share/man/man1"

BIN_URL="https://raw.githubusercontent.com/xJonathanLEI/starkli/master/starkliup/starkliup"
BIN_PATH="$STARKLI_BIN_DIR/starkliup"

ENV_PATH="$STARKLI_DIR/env"


mkdir -p $STARKLI_BIN_DIR
mkdir -p $STARKLI_MAN_DIR

curl -# -L $BIN_URL -o $BIN_PATH
chmod +x $BIN_PATH

# Generates the env file on the fly
echo '#!/bin/sh' > $ENV_PATH
echo '' >> $ENV_PATH
echo 'case ":${PATH}:" in' >> $ENV_PATH
echo '  *:"'${STARKLI_BIN_DIR}'":*)' >> $ENV_PATH
echo '    ;;' >> $ENV_PATH
echo '  *)' >> $ENV_PATH
echo '    export PATH="'${STARKLI_BIN_DIR}':$PATH"' >> $ENV_PATH
echo '    ;;' >> $ENV_PATH
echo 'esac' >> $ENV_PATH

# This detection here is just for showing the help message at the end.
IS_SUPPORTED_SHELL=""
case $SHELL in
*/zsh)
    IS_SUPPORTED_SHELL="1"
    ;;
*/bash)
    IS_SUPPORTED_SHELL="1"
    ;;
*/fish)
    IS_SUPPORTED_SHELL="1"
    ;;
*/ash)
    IS_SUPPORTED_SHELL="1"
    ;;
esac

# Inserts this line into whatever shell profile we find, regardless of what the active shell is.
ENV_LINE=". \"${ENV_PATH}\""
insert_env_line "$HOME/.profile"
insert_env_line "$HOME/.bashrc"
insert_env_line "$HOME/.bash_profile"
insert_env_line "${ZDOTDIR-"$HOME"}/.zshenv"
insert_env_line "$HOME/.config/fish/config.fish"

echo

if [ -n "$IS_SUPPORTED_SHELL" ]; then
    echo "Run '${yellow}. ${ENV_PATH}${normal}' or start a new terminal session to use starkliup."
    echo "Then, simply run ${yellow}starkliup${normal} to install starkli."
else
    echo "starkliup: could not detect shell. Add '${yellow}. ${ENV_PATH}${normal}' to your shell profile, or manually add '${yellow}${STARKLI_BIN_DIR}${normal}' to your PATH environment variable."
fi
